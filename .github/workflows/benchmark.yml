name: Architecture Benchmark - Percentile Regression

on:
  pull_request:
  push:
    branches: [main]

jobs:
  benchmark:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java 21
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Run Gradle build
      run: |
        chmod +x ./gradlew || true
        ./gradlew build --no-daemon

    # - name: Build images
    #   run: docker compose -f compose.grpc.yaml build

    - name: Start stack
      run: docker compose -f compose.grpc.yaml up -d


    - name: Install benchmark tools (ghz, jq, wrk2)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends jq git build-essential libssl-dev curl

        # install ghz
        GHZ_URL=$(curl -s https://api.github.com/repos/bojand/ghz/releases/latest | jq -r '.assets[] | select(.name|test("linux.*(amd64|x86_64)|linux_amd64")) | .browser_download_url' | head -n1)
        if [ -n "$GHZ_URL" ]; then
          curl -sL "$GHZ_URL" -o /tmp/ghz.tar.gz
          tar -xzf /tmp/ghz.tar.gz -C /tmp || true
          if [ -x /tmp/ghz ]; then sudo mv /tmp/ghz /usr/local/bin/ghz && sudo chmod +x /usr/local/bin/ghz; fi
        else
          echo "Failed to get ghz download URL" >&2
          exit 1
        fi

        # build wrk2 (provides wrk)
        git clone --depth 1 https://github.com/giltene/wrk2.git /tmp/wrk2
        (cd /tmp/wrk2 && make)
        sudo mv /tmp/wrk2/wrk /usr/local/bin/wrk
        rm -rf /tmp/wrk2 /tmp/ghz.tar.gz

    - name: gRPC benchmark
      run: |
        bash benchmarks/grpc.sh 5000 200 10
        bash benchmarks/grpc.sh 5000 200 30
 
    - name: gRPC percentile regression
      run: |
        cd benchmarks
        python3 compare_percentiles.py \
          baseline/grpc.json \
          results/grpc-5000rps-200-30s-8cpus.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmarks/results/
