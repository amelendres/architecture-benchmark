name: Architecture Benchmark - Percentile Regression

on:
  pull_request:
  push:
    branches: [main]

jobs:
  benchmark-grpc:
    if: false
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java 21
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Run Gradle build
      run: |
        chmod +x ./gradlew || true
        ./gradlew build --no-daemon

    - name: Start stack
      run: docker compose -f compose.grpc.yaml up -d

    - name: Install benchmark tools (jq, fortio)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends jq git build-essential libssl-dev curl
        
        bash benchmarks/install-fortio.sh
        fortio version 

    - name: gRPC benchmark
      run: |
        cd benchmarks
        bash benchmark.sh grpc localhost:9090 1000 10 6 10
        bash benchmark.sh grpc localhost:9090 5000 20 6 100
 
    - name: gRPC percentile regression
      run: |
        cd benchmarks
        python3 compare_percentiles.py \
          baseline/grpc.json \
          results/grpc-5000qps-20s-6c-100streams.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmarks/results/

    
  benchmark-webflux:
    runs-on: ubuntu-latest
    timeout-minutes: 20

    steps:
    - uses: actions/checkout@v4

    - name: Set up Java 21
      uses: actions/setup-java@v5
      with:
        distribution: 'temurin'
        java-version: '21'
        cache: 'gradle'

    - name: Run Gradle build
      run: |
        chmod +x ./gradlew || true
        ./gradlew build --no-daemon

    - name: Start stack
      run: docker compose -f compose.webflux.yaml up -d

    - name: Install benchmark tools (jq, fortio)
      run: |
        sudo apt-get update
        sudo apt-get install -y --no-install-recommends jq libssl-dev curl
        
        bash benchmarks/install-fortio.sh
        fortio version

    - name: Webflux benchmark
      run: |
        cd benchmarks
        bash benchmark.sh http-webflux localhost:8081 1000 10 6
        bash benchmark.sh http-webflux localhost:8081 5000 20 6
 
    - name: Webflux percentile regression
      run: |
        cd benchmarks
        python3 compare_percentiles.py \
          baseline/http-webflux.json \
          results/http-webflux-5000qps-20s-6c.json

    - name: Upload benchmark results
      uses: actions/upload-artifact@v4
      with:
        name: benchmark-results
        path: benchmarks/results/

